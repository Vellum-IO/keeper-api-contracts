asyncapi: "2.6.0"
info:
  title: DBaaS Shared Components
  version: "1.0.0"
  description: Shared message definitions and schemas for Backend and Operator.

components:
  schemas:
    # -----------------------
    # Reusable Data Objects
    # -----------------------
    ResourceSpec:
      type: object
      description: Compute and Storage requirements
      required:
        - cpu_millicores
        - ram_mb
        - storage_gb
      properties:
        cpu_millicores:
          type: integer
          description: CPU limit in millicores (1000 = 1 vCPU)
          minimum: 500
          maximum: 256000
        ram_mb:
          type: integer
          description: RAM limit in Megabytes
          minimum: 1024
          maximum: 1000000
        storage_gb:
          type: integer
          description: Storage size in Gigabytes
          minimum: 1
          maximum: 5000
        is_backup_enabled:
          type: boolean
          description: Whether backups are enabled for this database

    StatusCondition:
      type: object
      description: Kubernetes-style status condition
      required:
        - type
        - status
        - last_transition_time
      properties:
        type:
          type: string
          enum: ["Ready", "Provisioning", "BackingUp", "Degraded", "Stopped"]
        status:
          type: string
          enum: ["True", "False", "Unknown"]
        reason:
          type: string
          description: CamelCase machine-readable reason (e.g. QuotaExceeded)
        message:
          type: string
          description: Human-readable detail
        last_transition_time:
          type: string
          format: date-time

  messages:
    # -----------------------
    # Command Payloads
    # -----------------------
    CreateDatabase:
      name: CreateDatabase
      title: Create Database Payload
      contentType: application/json
      payload:
        type: object
        required:
          - team_id
          - db_uuid
          - instance_name
          - db_name
          - pg_version
          - resources
        properties:
          team_id:
            type: string
            format: uuid
            description: Organization/Team ID
          db_uuid:
            type: string
            format: uuid
            description: Unique Platform ID (generated by Backend)
          instance_name:
            type: string
            description: Unique identifier for the PostgreSQL server deployment in Kubernetes
            pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
            minLength: 3
            maxLength: 30
          db_name:
            type: string
            description: Name of the initial logical database created inside the instance
            pattern: ^[a-z][a-z0-9_]*$
            minLength: 3
            maxLength: 60
          pg_version:
            type: string
            example: "15.3"
          backup_enabled:
            type: boolean
            default: true
          resources:
            $ref: "#/components/schemas/ResourceSpec"

    UpdateDatabase:
      name: UpdateDatabase
      title: Update Database Payload
      contentType: application/json
      payload:
        type: object
        required:
          - team_id
          - db_uuid
          - instance_name
        properties:
          team_id:
            type: string
            format: uuid
          db_uuid:
            type: string
            format: uuid
          instance_name:
            type: string
            description: New name (if renaming)
          pg_version:
            type: string
            description: If present, triggers an upgrade
          backup_enabled:
            type: boolean
          resources:
            $ref: "#/components/schemas/ResourceSpec"

    DeleteDatabase:
      name: DeleteDatabase
      title: Delete Database Payload
      contentType: application/json
      payload:
        type: object
        required:
          - team_id
          - db_uuid
          - instance_name
        properties:
          team_id:
            type: string
            format: uuid
          db_uuid:
            type: string
            format: uuid
          instance_name:
            type: string

    # -----------------------
    # Event Payloads
    # -----------------------
    StatusEvent:
      name: StatusEvent
      title: Status Change Event
      contentType: application/json
      payload:
        type: object
        required:
          - db_uuid
          - condition
          - timestamp
        properties:
          db_uuid:
            type: string
            format: uuid
          timestamp:
            type: string
            format: date-time
          condition:
            $ref: "#/components/schemas/StatusCondition"

    CredentialEvent:
      name: CredentialEvent
      title: Connection Secrets Event
      contentType: application/json
      payload:
        type: object
        required:
          - db_uuid
          - connection_details
        properties:
          db_uuid:
            type: string
            format: uuid
          connection_details:
            type: object
            required:
              - username
              - password
              - connection_string
            properties:
              username: { type: string }
              password: { type: string }
              connection_string: { type: string }
              tls_certs:
                type: object
                properties:
                  ca: { type: string }
                  cert: { type: string }
                  key: { type: string }
