asyncapi: 3.1.0
info:
  title: Keeper Backend API
  version: 1.0.0
  description: >
    Specification for the Keeper Backend Control Plane.

    - Publishes Commands: declarative spec (create/update reconciled by
    operator) and delete.

    - Spec subject includes database ID so only one message per database is
    relevant (newest wins).

    - Subscribes to Events (Status/Credentials)
servers:
  production:
    host: 'nats.internal:4222'
    protocol: nats
    description: Production NATS Cluster
channels:
  specCommand:
    address: 'keeper.cluster.{clusterId}.command.spec.{databaseId}'
    description: >-
      Declarative desired spec for a database. Operator reconciles (create or
      update). One message per database; newest wins when queued.
    messages:
      databaseSpec:
        $ref: '#/components/messages/DatabaseSpec'
    parameters:
      clusterId:
        $ref: '#/components/parameters/clusterId'
      databaseId:
        $ref: '#/components/parameters/databaseId'
  deleteCommand:
    address: 'keeper.cluster.{clusterId}.command.delete'
    messages:
      deleteDatabase:
        $ref: '#/components/messages/DeleteDatabase'
    parameters:
      clusterId:
        $ref: '#/components/parameters/clusterId'
  statusEvent:
    address: 'keeper.cluster.{clusterId}.event.status'
    messages:
      statusEvent:
        $ref: '#/components/messages/StatusEvent'
    parameters:
      clusterId:
        $ref: '#/components/parameters/clusterId'
  credentialEvent:
    address: 'keeper.cluster.{clusterId}.event.credentials'
    messages:
      credentialEvent:
        $ref: '#/components/messages/CredentialEvent'
    parameters:
      clusterId:
        $ref: '#/components/parameters/clusterId'
operations:
  sendDatabaseSpec:
    action: receive
    channel:
      $ref: '#/channels/specCommand'
    summary: >-
      Send desired database spec; operator reconciles (create or update).
      Subject includes database ID so only newest spec per database is used.
  deleteDatabase:
    action: receive
    channel:
      $ref: '#/channels/deleteCommand'
    summary: Deprovision a Database
  statusEvent:
    action: send
    channel:
      $ref: '#/channels/statusEvent'
    summary: 'Listen for state changes (PENDING, PROVISIONING, READY, FAILED, DELETING)'
  credentialEvent:
    action: send
    channel:
      $ref: '#/channels/credentialEvent'
    summary: Listen for new credentials/secrets
components:
  parameters:
    clusterId:
      description: Unique identifier for the Kubernetes cluster
    databaseId:
      description: >-
        Unique platform ID of the database (UUID). Included in subject so only
        one message per database is relevant in the queue.
  schemas:
    ResourceSpec:
      type: object
      description: Compute and Storage requirements
      required:
        - cpu_millicores
        - ram_mb
        - storage_gb
      properties:
        cpu_millicores:
          type: integer
          description: CPU limit in millicores (1000 = 1 vCPU)
          minimum: 500
          maximum: 256000
        ram_mb:
          type: integer
          description: RAM limit in Megabytes
          minimum: 1024
          maximum: 1000000
        storage_gb:
          type: integer
          description: Storage size in Gigabytes
          minimum: 1
          maximum: 5000
        is_backup_enabled:
          type: boolean
          description: Whether backups are enabled for this database
        postgres_version:
          type: string
          pattern: ^\d+(\.\d+)?(\.\d+)?$
          description: >-
            PostgreSQL version as X, X.X, or X.X.X (e.g. 14, 14.5, 14.5.1).
            Valid versions enforced by backend.
          example: 14.5.1
        high_availability_enabled:
          type: boolean
          description: >-
            When true, database runs with 3 replicas (HA); when false, 1
            replica.
    StatusCondition:
      type: object
      description: Kubernetes-style status condition
      required:
        - type
        - status
        - last_transition_time
      properties:
        type:
          type: string
          description: Condition type indicating the state of the database
          enum:
            - PENDING
            - PROVISIONING
            - READY
            - FAILED
            - DELETING
        status:
          type: string
          description: >-
            Status of the condition (True if condition is met, False if not,
            Unknown if status cannot be determined)
          enum:
            - 'True'
            - 'False'
            - Unknown
        reason:
          type: string
          description: CamelCase machine-readable reason (e.g. QuotaExceeded)
        message:
          type: string
          description: Human-readable detail
        last_transition_time:
          type: string
          format: date-time
          description: Timestamp when the condition last transitioned to its current status
  messages:
    DatabaseSpec:
      name: DatabaseSpec
      title: Database Spec Payload (declarative)
      contentType: application/json
      description: >-
        Desired state for a database. Operator reconciles (creates or updates).
        Only the newest message per database (subject includes database ID) is
        used.
      payload:
        type: object
        required:
          - team_id
          - db_uuid
          - instance_name
          - database_name
          - resources
        properties:
          team_id:
            type: string
            format: uuid
            description: Organization/Team ID
          db_uuid:
            type: string
            format: uuid
            description: >-
              Unique Platform ID (generated by Backend); must match databaseId
              in channel subject
          instance_name:
            type: string
            description: >-
              Unique identifier for the PostgreSQL server deployment in
              Kubernetes
            pattern: '^[a-z0-9]([-a-z0-9]*[a-z0-9])?$'
            minLength: 3
            maxLength: 30
          database_name:
            type: string
            description: Name of the initial logical database created inside the instance
            pattern: '^[a-z][a-z0-9_]*$'
            minLength: 3
            maxLength: 60
          resources:
            $ref: '#/components/schemas/ResourceSpec'
    DeleteDatabase:
      name: DeleteDatabase
      title: Delete Database Payload
      contentType: application/json
      payload:
        type: object
        required:
          - team_id
          - db_uuid
          - instance_name
        properties:
          team_id:
            type: string
            format: uuid
            description: Team ID that owns the database
          db_uuid:
            type: string
            format: uuid
            description: Unique Platform ID of the database to delete
          instance_name:
            type: string
            description: >-
              Unique identifier for the PostgreSQL server deployment in
              Kubernetes
    StatusEvent:
      name: StatusEvent
      title: Status Change Event
      contentType: application/json
      payload:
        type: object
        required:
          - db_uuid
          - condition
          - timestamp
        properties:
          db_uuid:
            type: string
            format: uuid
            description: Unique Platform ID of the database whose status changed
          timestamp:
            type: string
            format: date-time
            description: Timestamp when the status event occurred
          condition:
            $ref: '#/components/schemas/StatusCondition'
    CredentialEvent:
      name: CredentialEvent
      title: Connection Secrets Event
      contentType: application/json
      payload:
        type: object
        required:
          - db_uuid
          - connection_details
        properties:
          db_uuid:
            type: string
            format: uuid
            description: >-
              Unique Platform ID of the database for which credentials are
              provided
          connection_details:
            type: object
            description: Database connection credentials and connection information
            required:
              - username
              - password
              - connection_string
            properties:
              username:
                type: string
                description: Database username for authentication
              password:
                type: string
                description: Database password for authentication
              connection_string:
                type: string
                description: >-
                  Full connection string (host, port, database name) for
                  connecting to the database
              tls_certs:
                type: object
                description: TLS certificate files for secure database connections
                properties:
                  ca:
                    type: string
                    description: Certificate Authority (CA) certificate in PEM format
                  cert:
                    type: string
                    description: Client certificate in PEM format
                  key:
                    type: string
                    description: Client private key in PEM format
