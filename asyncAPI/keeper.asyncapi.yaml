asyncapi: "2.6.0"
info:
  title: Keeper Backend API
  version: "1.0.0"
  description: |
    Specification for the Keeper Backend Control Plane.
    - Publishes Commands (Create/Update/Delete)
    - Subscribes to Events (Status/Credentials)

servers:
  production:
    url: nats://nats.internal:4222
    protocol: nats
    description: Production NATS Cluster

channels:
  # --------
  # COMMANDS
  # --------
  keeper.cluster.{clusterId}.command.create:
    parameters:
      clusterId:
        schema: { type: string }
        description: Unique identifier for the Kubernetes cluster where the database will be provisioned
    publish:
      operationId: sendCreateCommand
      summary: Order a new Database
      message:
        $ref: "#/components/messages/CreateDatabase"

  keeper.cluster.{clusterId}.command.update:
    parameters:
      clusterId:
        schema: { type: string }
        description: Unique identifier for the Kubernetes cluster where the database is deployed
    publish:
      operationId: sendUpdateCommand
      summary: Update existing Database specs
      message:
        $ref: "#/components/messages/UpdateDatabase"

  keeper.cluster.{clusterId}.command.delete:
    parameters:
      clusterId:
        schema: { type: string }
        description: Unique identifier for the Kubernetes cluster where the database is deployed
    publish:
      operationId: sendDeleteCommand
      summary: Deprovision a Database
      message:
        $ref: "#/components/messages/DeleteDatabase"

  # ------
  # EVENTS
  # ------
  keeper.cluster.{clusterId}.event.status:
    parameters:
      clusterId:
        schema: { type: string }
        description: Unique identifier for the Kubernetes cluster where status events originate
    subscribe:
      operationId: receiveStatusEvent
      summary: Listen for state changes (PENDING, PROVISIONING, READY, FAILED, DELETING)
      message:
        $ref: "#/components/messages/StatusEvent"

  keeper.cluster.{clusterId}.event.credentials:
    parameters:
      clusterId:
        schema: { type: string }
        description: Unique identifier for the Kubernetes cluster where credential events originate
    subscribe:
      operationId: receiveCredentialEvent
      summary: Listen for new credentials/secrets
      message:
        $ref: "#/components/messages/CredentialEvent"

components:
  schemas:
    # -----------------------
    # Reusable Data Objects
    # -----------------------
    ResourceSpec:
      type: object
      description: Compute and Storage requirements
      required:
        - cpu_millicores
        - ram_mb
        - storage_gb
      properties:
        cpu_millicores:
          type: integer
          description: CPU limit in millicores (1000 = 1 vCPU)
          minimum: 500
          maximum: 256000
        ram_mb:
          type: integer
          description: RAM limit in Megabytes
          minimum: 1024
          maximum: 1000000
        storage_gb:
          type: integer
          description: Storage size in Gigabytes
          minimum: 1
          maximum: 5000
        is_backup_enabled:
          type: boolean
          description: Whether backups are enabled for this database

    StatusCondition:
      type: object
      description: Kubernetes-style status condition
      required:
        - type
        - status
        - last_transition_time
      properties:
        type:
          type: string
          description: Condition type indicating the state of the database
          enum: ["PENDING", "PROVISIONING", "READY", "FAILED", "DELETING"]
        status:
          type: string
          description: Status of the condition (True if condition is met, False if not, Unknown if status cannot be determined)
          enum: ["True", "False", "Unknown"]
        reason:
          type: string
          description: CamelCase machine-readable reason (e.g. QuotaExceeded)
        message:
          type: string
          description: Human-readable detail
        last_transition_time:
          type: string
          format: date-time
          description: Timestamp when the condition last transitioned to its current status

  messages:
    # -----------------------
    # Command Payloads
    # -----------------------
    CreateDatabase:
      name: CreateDatabase
      title: Create Database Payload
      contentType: application/json
      payload:
        type: object
        required:
          - team_id
          - db_uuid
          - instance_name
          - database_name
          - pg_version
          - resources
        properties:
          team_id:
            type: string
            format: uuid
            description: Organization/Team ID
          db_uuid:
            type: string
            format: uuid
            description: Unique Platform ID (generated by Backend)
          instance_name:
            type: string
            description: Unique identifier for the PostgreSQL server deployment in Kubernetes
            pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
            minLength: 3
            maxLength: 30
          database_name:
            type: string
            description: Name of the initial logical database created inside the instance
            pattern: ^[a-z][a-z0-9_]*$
            minLength: 3
            maxLength: 60
          pg_version:
            type: string
            description: PostgreSQL version to deploy (e.g., "18.0")
            pattern: ^\d+\.\d+(\.\d+)?$
            example: "18.0"
          is_backup_enabled:
            type: boolean
            description: Whether automated backups should be enabled for this database
            default: true
          resources:
            $ref: "#/components/schemas/ResourceSpec"

    UpdateDatabase:
      name: UpdateDatabase
      title: Update Database Payload
      contentType: application/json
      payload:
        type: object
        required:
          - team_id
          - db_uuid
          - instance_name
        properties:
          team_id:
            type: string
            format: uuid
            description: Team ID that owns the database
          db_uuid:
            type: string
            format: uuid
            description: Unique Platform ID of the database to update
          instance_name:
            type: string
            description: The name of the instance to update (name has to match an existing instance name)
          pg_version:
            type: string
            description: If present, triggers an upgrade to the specified PostgreSQL version
            pattern: ^\d+\.\d+(\.\d+)?$
          is_backup_enabled:
            type: boolean
            description: Whether automated backups should be enabled for this database
          resources:
            $ref: "#/components/schemas/ResourceSpec"

    DeleteDatabase:
      name: DeleteDatabase
      title: Delete Database Payload
      contentType: application/json
      payload:
        type: object
        required:
          - team_id
          - db_uuid
          - instance_name
        properties:
          team_id:
            type: string
            format: uuid
            description: Team ID that owns the database
          db_uuid:
            type: string
            format: uuid
            description: Unique Platform ID of the database to delete
          instance_name:
            type: string
            description: Unique identifier for the PostgreSQL server deployment in Kubernetes

    # -----------------------
    # Event Payloads
    # -----------------------
    StatusEvent:
      name: StatusEvent
      title: Status Change Event
      contentType: application/json
      payload:
        type: object
        required:
          - db_uuid
          - condition
          - timestamp
        properties:
          db_uuid:
            type: string
            format: uuid
            description: Unique Platform ID of the database whose status changed
          timestamp:
            type: string
            format: date-time
            description: Timestamp when the status event occurred
          condition:
            $ref: "#/components/schemas/StatusCondition"

    CredentialEvent:
      name: CredentialEvent
      title: Connection Secrets Event
      contentType: application/json
      payload:
        type: object
        required:
          - db_uuid
          - connection_details
        properties:
          db_uuid:
            type: string
            format: uuid
            description: Unique Platform ID of the database for which credentials are provided
          connection_details:
            type: object
            description: Database connection credentials and connection information
            required:
              - username
              - password
              - connection_string
            properties:
              username:
                type: string
                description: Database username for authentication
              password:
                type: string
                description: Database password for authentication
              connection_string:
                type: string
                description: Full connection string (host, port, database name) for connecting to the database
              tls_certs:
                type: object
                description: TLS certificate files for secure database connections
                properties:
                  ca:
                    type: string
                    description: Certificate Authority (CA) certificate in PEM format
                  cert:
                    type: string
                    description: Client certificate in PEM format
                  key:
                    type: string
                    description: Client private key in PEM format
